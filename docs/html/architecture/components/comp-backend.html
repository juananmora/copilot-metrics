<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Componente: Backend WebSocket Server</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --background-color: #ffffff;
            --surface-color: #f8fafc;
            --text-color: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --code-bg: #f1f5f9;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .nav-breadcrumb {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--surface-color);
            border-radius: 8px;
            font-size: 0.875rem;
        }
        
        .nav-breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .nav-breadcrumb a:hover { text-decoration: underline; }
        
        h1, h2, h3, h4, h5, h6 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
            line-height: 1.3;
        }
        
        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }
        
        h2 {
            font-size: 1.875rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.25rem; color: var(--secondary-color); }
        
        p { margin-bottom: 1rem; }
        
        a { color: var(--primary-color); text-decoration: none; }
        a:hover { text-decoration: underline; }
        
        ul, ol { margin-bottom: 1rem; padding-left: 2rem; }
        li { margin-bottom: 0.5rem; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }
        
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--surface-color);
            font-weight: 600;
        }
        
        tr:nth-child(even) { background-color: var(--surface-color); }
        tr:hover { background-color: #f1f5f9; }
        
        code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            background-color: var(--code-bg);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }
        
        pre {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5rem 0;
        }
        
        pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        
        .mermaid {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            text-align: center;
        }
        
        blockquote {
            border-left: 4px solid var(--primary-color);
            margin: 1.5rem 0;
            padding: 1rem 1.5rem;
            background-color: var(--surface-color);
            border-radius: 0 8px 8px 0;
        }
        
        blockquote p:last-child { margin-bottom: 0; }
        
        hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 2rem 0;
        }
        
        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .doc-footer {
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        @media (max-width: 768px) {
            body { padding: 1rem; }
            h1 { font-size: 1.875rem; }
            h2 { font-size: 1.5rem; }
            table { display: block; overflow-x: auto; }
        }
        
        @media print {
            body { max-width: none; padding: 0; }
            .nav-breadcrumb { display: none; }
            pre { white-space: pre-wrap; }
        }
    </style>
</head>
<body>
    <nav class="nav-breadcrumb"><a href="index.html">Inicio</a> / <a href="../../index.html">architecture</a> / <a href="../index.html">components</a> / <span>comp-backend</span></nav>
    <article>
        <h1>Componente: Backend WebSocket Server</h1>
<h2>Información General</h2>
<table>
<thead>
<tr>
<th>Atributo</th>
<th>Valor</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Tipo</strong></td>
<td>Servidor Node.js</td>
</tr>
<tr>
<td><strong>Responsabilidad</strong></td>
<td>API REST, WebSocket, Caché, GitHub Integration</td>
</tr>
<tr>
<td><strong>Ubicación</strong></td>
<td><code>server/src/</code></td>
</tr>
<tr>
<td><strong>Tecnologías</strong></td>
<td>Node.js, Express, ws, Axios</td>
</tr>
</tbody></table>
<h2>Descripción</h2>
<p>El backend es un servidor Node.js que actúa como intermediario entre el frontend y la API de GitHub Enterprise. Proporciona comunicación en tiempo real via WebSocket, caché en memoria para optimizar llamadas a la API, y endpoints REST como fallback.</p>
<h2>Diagrama de Componentes</h2>
<div class="mermaid">
graph TB
    subgraph "Backend Server"
        subgraph "HTTP Layer"
            EXP[Express App]
            CORS[CORS Middleware]
            REST[REST Endpoints]
        end
        
        subgraph "WebSocket Layer"
            WSS[WebSocket Server]
            CM[Client Manager]
            BC[Broadcaster]
        end
        
        subgraph "Business Logic"
            GHS[GitHub Service]
            DS[Data Service]
        end
        
        subgraph "Data Layer"
            CACHE[Memory Cache]
            TTL[TTL Manager]
        end
    end
    
    EXP --> CORS
    CORS --> REST
    
    WSS --> CM
    CM --> BC
    
    REST --> DS
    BC --> DS
    DS --> CACHE
    DS --> GHS
    
    CACHE --> TTL
    GHS --> API[GitHub API]
</div>

<h2>Endpoints REST</h2>
<table>
<thead>
<tr>
<th>Endpoint</th>
<th>Método</th>
<th>Descripción</th>
</tr>
</thead>
<tbody><tr>
<td><code>/api/health</code></td>
<td>GET</td>
<td>Health check y estadísticas</td>
</tr>
<tr>
<td><code>/api/dashboard</code></td>
<td>GET</td>
<td>Datos completos del dashboard</td>
</tr>
<tr>
<td><code>/api/kpis</code></td>
<td>GET</td>
<td>Solo KPIs para carga rápida</td>
</tr>
<tr>
<td><code>/api/contributors/:repo</code></td>
<td>GET</td>
<td>Contribuidores de un repositorio</td>
</tr>
<tr>
<td><code>/api/reviewers</code></td>
<td>GET</td>
<td>Ranking de revisores de PRs</td>
</tr>
</tbody></table>
<h2>Mensajes WebSocket</h2>
<h3>Cliente → Servidor</h3>
<pre><code class="language-typescript">// Suscribirse a un canal
{ &quot;type&quot;: &quot;subscribe&quot;, &quot;channel&quot;: &quot;dashboard&quot; }

// Solicitar actualización manual
{ &quot;type&quot;: &quot;refresh&quot; }

// Keep-alive
{ &quot;type&quot;: &quot;ping&quot; }
</code></pre>
<h3>Servidor → Cliente</h3>
<pre><code class="language-typescript">// Conexión establecida
{ &quot;type&quot;: &quot;connected&quot;, &quot;clientId&quot;: &quot;...&quot; }

// Datos iniciales/actualizados
{ 
  &quot;type&quot;: &quot;initial&quot; | &quot;update&quot;, 
  &quot;phase&quot;: &quot;kpis&quot; | &quot;complete&quot;, 
  &quot;data&quot;: {...} 
}

// Actualización en progreso
{ &quot;type&quot;: &quot;refreshing&quot; }

// Rate limited
{ &quot;type&quot;: &quot;rate_limit&quot;, &quot;retryAfter&quot;: 10 }

// Error
{ &quot;type&quot;: &quot;error&quot;, &quot;message&quot;: &quot;...&quot;, &quot;code&quot;: &quot;...&quot; }
</code></pre>
<h2>Flujo de Conexión WebSocket</h2>
<div class="mermaid">
sequenceDiagram
    autonumber
    
    participant C as Cliente
    participant WS as WebSocket Server
    participant CM as Client Manager
    participant DS as Data Service
    participant Cache as Cache
    
    C->>WS: Conectar
    WS->>CM: Registrar cliente
    CM-->>C: connected(clientId)
    
    C->>WS: subscribe("dashboard")
    WS->>CM: Añadir suscripción
    
    WS->>Cache: Obtener datos
    
    alt Cache hit
        Cache-->>WS: Datos cacheados
        WS-->>C: initial(data, isStale)
    else Cache miss
        WS->>DS: Fetch fresh data
        DS-->>WS: Nuevos datos
        WS->>Cache: Guardar
        WS-->>C: initial(data)
    end
</div>

<h2>Configuración</h2>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Tipo</th>
<th>Default</th>
<th>Descripción</th>
</tr>
</thead>
<tbody><tr>
<td><code>PORT</code></td>
<td>number</td>
<td>3001</td>
<td>Puerto del servidor</td>
</tr>
<tr>
<td><code>GITHUB_TOKEN</code></td>
<td>string</td>
<td>-</td>
<td>Token de GitHub Enterprise</td>
</tr>
<tr>
<td><code>GITHUB_API_URL</code></td>
<td>string</td>
<td>bbva.ghe.com/api/v3</td>
<td>URL de la API</td>
</tr>
<tr>
<td><code>GITHUB_ORG</code></td>
<td>string</td>
<td>copilot-full-capacity</td>
<td>Organización</td>
</tr>
<tr>
<td><code>FRONTEND_URL</code></td>
<td>string</td>
<td>localhost:3000</td>
<td>Origen CORS permitido</td>
</tr>
<tr>
<td><code>CACHE_TTL</code></td>
<td>number</td>
<td>30</td>
<td>TTL de caché en segundos</td>
</tr>
</tbody></table>
<h2>Manejo de Errores</h2>
<table>
<thead>
<tr>
<th>Código</th>
<th>Nombre</th>
<th>Descripción</th>
<th>Acción</th>
</tr>
</thead>
<tbody><tr>
<td>FETCH_ERROR</td>
<td>Error de fetch</td>
<td>Fallo al obtener datos de GitHub</td>
<td>Broadcast error a clientes</td>
</tr>
<tr>
<td>RATE_LIMIT</td>
<td>Rate limited</td>
<td>Demasiadas solicitudes</td>
<td>Retornar tiempo de espera</td>
</tr>
<tr>
<td>AUTH_ERROR</td>
<td>Autenticación</td>
<td>Token inválido</td>
<td>Log y error a cliente</td>
</tr>
<tr>
<td>CONN_ERROR</td>
<td>Conexión</td>
<td>Error de conexión WS</td>
<td>Cleanup y reconexión</td>
</tr>
</tbody></table>
<h2>Sistema de Caché</h2>
<div class="mermaid">
flowchart TD
    REQ[Request] --> CHECK{Cache válido?}
    CHECK -->|Sí| RET[Retornar datos]
    CHECK -->|No| FETCH[Fetch GitHub]
    FETCH --> STORE[Guardar en cache]
    STORE --> RET
    
    subgraph "Cache Keys"
        K1[dashboard:full]
        K2[dashboard:kpis]
        K3[contributors_repo]
        K4[pr_reviewers]
    end
</div>

<h2>Broadcast a Clientes</h2>
<pre><code class="language-typescript">function broadcast(channel: string, message: WSMessage): void {
  clients.forEach((info, ws) =&gt; {
    if (ws.readyState === WebSocket.OPEN &amp;&amp; 
        info.subscriptions.has(channel)) {
      ws.send(JSON.stringify(message));
    }
  });
}
</code></pre>
<h2>Rate Limiting</h2>
<ul>
<li><strong>Límite</strong>: 1 refresh manual cada 10 segundos por cliente</li>
<li><strong>Implementación</strong>: Timestamp de último refresh por clientId</li>
<li><strong>Respuesta</strong>: <code>rate_limit</code> con <code>retryAfter</code> en segundos</li>
</ul>
<h2>Dependencias</h2>
<h3>Internas</h3>
<ul>
<li><code>cache.ts</code> - Sistema de caché en memoria</li>
<li><code>githubService.ts</code> - Cliente de GitHub API</li>
<li><code>types.ts</code> - Definiciones TypeScript</li>
</ul>
<h3>Externas</h3>
<table>
<thead>
<tr>
<th>Librería</th>
<th>Propósito</th>
</tr>
</thead>
<tbody><tr>
<td><code>express</code></td>
<td>HTTP server</td>
</tr>
<tr>
<td><code>ws</code></td>
<td>WebSocket server</td>
</tr>
<tr>
<td><code>cors</code></td>
<td>CORS middleware</td>
</tr>
<tr>
<td><code>axios</code></td>
<td>Cliente HTTP para GitHub</td>
</tr>
<tr>
<td><code>dotenv</code></td>
<td>Variables de entorno</td>
</tr>
<tr>
<td><code>tsx</code></td>
<td>TypeScript execution en desarrollo</td>
</tr>
</tbody></table>

    </article>
    <footer class="doc-footer">
        <p>Documentación generada automáticamente el 04/02/2026, 10:02</p>
    </footer>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: true, htmlLabels: true }
        });
    </script>
</body>
</html>